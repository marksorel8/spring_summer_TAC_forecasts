---
title: "OPI Forecasts"
author: Thomas Buehrens (tbuehrens@dfw.wa.gov), Mark Sorel (mark.sorel@dfw.wa.gov), ...
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---


<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://privatelands.wdfw.wa.gov/wdfwlogo_clrnotxt.png"\" style=\"float: right;width: 150px;\"/>')
   });
</script>
***

Last Updated `r format(Sys.time(), '%m/%d/%Y')`.

***

# Overview
This script fits Seasonal Auto-Regressive Integrated Moving Average (SARIMA) models to in-season salmon return data to predict total return. It does this by aggregating the run-size into two periods: counts prior to a particular date (often the date of the most recent observation), and counts after that date (i.e., the remainder of the run). It then predicts the remainder of the run using the pattern of abundance before and after that date in previous years, in conjunction with covariates. This software evaluates the model's skill at predicting the remainder of the runsize based on data collected up to a particular date. A forecast for the final year, including confidence intervals, is produced.

<!-- ## Setup -->
<!-- All analyses require R software [**(link)**](https://cran.r-project.org/) (v3.4.3) for data retrieval, data processing, and summarizing model results. Here we configure R to perform our analysis and generate our outputs -->
```{r set_options, echo = TRUE, message = FALSE}
options(width = 100)
knitr::opts_chunk$set(message = FALSE)
set.seed(123)
```

<!-- We also need a couple of helper functions which we will define -->
```{r load_funcs, message = FALSE, warning = FALSE,results = "hide"}
wd_functions<-"functions"
sapply(FUN = source, paste(wd_functions, list.files(wd_functions), sep="/"))
```

<!-- Here we will load & install packages we need to use (needs internet connection if packages not already installed) -->
```{r load_packages, message = FALSE, warning = FALSE,results = "hide"}
packages_list<-c("tidyverse"
                 ,"forecast"
                 ,"mgcv"
                 ,"ggplot2"
                 ,"MASS"
                 ,"RColorBrewer"
                 ,"kableExtra"
                 ,"modelr"
                 ,"kableExtra"
                 ,"reshape2"
                 ,"ggfortify"
                 ,"clock"
                 ,"smooth"
                 ,"scales"
                 ,"gtools"
                 ,"CombMSC"
                 ,"here"
                 ,"MuMIn"
                 ,"janitor"
                 ,"rvest"
                 ,"lubridate"
                 ,"rnoaa"
                 ,"ncdf4"
                 )
install_or_load_pack(pack = packages_list)
```

## User Inputs 
Look at this section to see user inputs regarding the years and dates of data analyzed and covariates used.
```{r user_inputs_data, message = FALSE, warning = FALSE,results = "show"}
#=========
# Raw Data
#=========
yr_start<-2002
yr_end<-year(Sys.Date())
#dam="BON"
species="Coho"
#===========================
# Summarization for analysis
#===========================
date_start_analysis<-ymd("2002/1/1") #this will be the first date of data used in the analysis (and this month/day first in years thereafter)
date_end_analysis<-ymd("2023/12/31") #this will be the last date of data used in the analysis (and this month/day last in years preceding)
forecast_period_start_m<-1 #this will be the month associated with the first month/day of the seasonal estimate period each year...can be after first data used to estimate it or the same
forecast_period_start_d<-1 #this will be the month day associated with the first month/day of the seasonal estimate period each year...can be after first data used to estimate it or the same
last_data<-Sys.Date()
#==================
#forecasting params
#==================
leave_yrs<- 11
covariates<-c(#oldschool
              "lag1_JackOPI",
              "lag1_SmAdj",
              #new
              "lag1_log_JackOPI",
              "lag1_NPGO",
              "lag1_PDO",
              "lag1_PC1",
              "WSST_A"
              ) 
plot_results = F
first_forecast_period = 1
write_model_summaries = TRUE
find_best=T
#==============
#Ensemble Params
#===============
min_vars<-1
max_vars<-6
forecast_type<-"preseason"
stack_metric<-"MAPE"
num_models<-20
```

## Get Raw Data
Data is loaded here a a snapshot of the data used in the analysis (before aggregation into the two periods described) is provided.


We get this data from Eric Suring's GitHub repo with the existing OPIH forecast. The following definitions for variables were supplied by ODFW: 

Jack OPI = Total Jack CR and Jack OC.
d/ Jack CR = Columbia River jack returns corrected for small adults. 
e/ Jack OC = Oregon coastal and California hatchery jack returns corrected for small adults. 
f/ Total OPI = Columbia River (Sm D + Sm CR), Oregon coastal and Klamath Basin. 
g/ Sm CR = Columbia River smolt releases from the previous year expected to return as adults in the year listed. 
h/ Sm D = Columbia River delayed smolt releases from the previous year expected to return as adults in the year listed


```{r get_data, message=FALSE, warning=FALSE, results="show"}
OPIHData <- read.table("https://raw.githubusercontent.com/ErikSuring/OPIH_Evaluation/main/PUB2023.txt", header = TRUE, sep = "\t", strip.white = TRUE, comment.char = "#")

nYears <- length(OPIHData[,1])
earliestYear <- OPIHData[1,1]
latestYear <- OPIHData[nYears,1]

OPIHData$AdltAll <- c(OPIHData$AdltSRS[1:17],OPIHData$AdltMSM[18:nYears])   # row 18  <-  1986. Use SRS data prior, MSM data post
OPIHData$AdltAllno83 <- OPIHData$AdltAll
OPIHData$AdltAllno83[15] <-  NA   #  1983 is removed from model input data
OPIHData[,"AdltAll"] <- OPIHData$AdltAll
OPIHData[,"AdltAllno83"] <- OPIHData$AdltAllno83

# Lag Jack and Smolt data to return year
OPIHData[,"lagJackCR"] <- c(NA, OPIHData$JackCR[1:nYears-1])
OPIHData[,"lagJackOC"] <- c(NA, OPIHData$JackOC[1:nYears-1])
OPIHData[,"lagJackOPI"] <- OPIHData$lagJackCR + OPIHData$lagJackOC

OPIHData[,"lagSmD"] <- c(NA, OPIHData$SmD[1:nYears-1])
OPIHData[,"lagSmCR"] <- c(NA, OPIHData$SmCR[1:nYears-1])
OPIHData[,"lagSmAdj"] <- OPIHData$lagJackCR*(OPIHData$lagSmD/OPIHData$lagSmCR)   #  Calculate Smolt Adjustment

# Output OPIHData as a .csv file
#write.table(OPIHData, file = "OPIHData.csv", sep = ", ", row.names=FALSE)

OPIHData%<>% 
  as_tibble()%>%
  arrange(Year)%>%
  dplyr::select(year=Year,
                abundance = AdltAllno83,
                lag1_JackOPI = lagJackOPI,
                lag1_SmAdj = lagSmAdj
                )
  
Yrlist<-data.frame(year=c(min(OPIHData$year):(max(OPIHData$year)+1)))

#=========================================================
#get PDO data
#=========================================================
PDO<-read_table("https://psl.noaa.gov/pdo/data/pdo.timeseries.ersstv5.csv",skip=1,col_names=F,comment="#")%>%
  dplyr::rename(Date=X1,PDO=X2)%>%
  filter(!PDO < -99)%>%
  mutate(Date=as.Date(Date),Month=month(Date),Year=as.integer(year(Date)))%>%
  group_by(Year)%>%
  add_tally()%>%
  #filter(!Month>6)%>% #use only spring (Jan-June) NPGO
  #filter(!n < 12)%>% #use only complete years
  group_by(Year)%>%
  dplyr::rename(year=Year)%>%
  dplyr::summarise(PDO=mean(PDO))%>%
  mutate(lag1_PDO = lag(PDO,1))%>%
  right_join(Yrlist)%>%
  dplyr::select(year,lag1_PDO)%>%
  filter(!is.na(lag1_PDO))
#=========================================================
#get NPGO data
#=========================================================
NPGO<-read_table("http://www.o3d.org/npgo/npgo.php",skip=29,col_names=F,comment="#")%>%
  filter(!is.na(X2))%>%
  dplyr::rename(Year=X1,Month=X2,NPGO=X3)%>%
  mutate(Year=as.integer(as.numeric(Year)))%>%
  group_by(Year)%>%
  add_tally()%>%
  #filter(!Month>6)%>% #use only spring (Jan-June) NPGO
  #filter(!n < 12)%>% #use only complete years
  group_by(Year)%>%
  dplyr::summarise(NPGO=mean(NPGO))%>%
  dplyr::rename(year=Year)%>%
  mutate(lag1_NPGO = lag(NPGO))%>%
  right_join(Yrlist)%>%
  arrange(year)%>%
  dplyr::select(year,lag1_NPGO)%>%
  filter(!is.na(lag1_NPGO))
#=========================================================
#get NOAA indicator data, wrangle into usable format, plot
#=========================================================
indicators<-read_csv("https://www.fisheries.noaa.gov/s3//2022-12/OEI-spotlight-cvs-2022-NWFSC.csv",skip=1)%>%
  filter(!is.na(`Ecosystem Indicators`))%>%
  pivot_longer(names_to = "Year",
                cols=c(starts_with("1"),starts_with("2")),
                values_to = "value")%>%
  pivot_wider(names_from=`Ecosystem Indicators`,values_from=value)%>%
  mutate(year=as.integer(Year))%>%
  right_join(Yrlist)%>%
  arrange(year)%>%
  mutate(lag1_PC1 = lag(scale(`Principal Component scores (PC1)`)[,1]))%>%
  dplyr::select(year,lag1_PC1)%>%
  filter(!is.na(lag1_PC1))

#===========================================================================================================
#Get ERSST data: get_ersst_v5_data takes A LONG TIME (1 hr) vs. get_ersst_v5_data_V2 which is much quicker!
#===========================================================================================================
#dat<-get_ersst_v5_data(years=c(1969:year(Sys.Date())),data.dir=getwd(),latrange=c(44,52),lonrange=c(-130,-120))

sstdat<-get_ersst_v5_data_V2(years=c(min(Yrlist$year):max(Yrlist$year)),
                             data.dir="C:\\Users\\buehrtwb\\Washington State Executive Branch Agencies\\DFW-Team WDFW OPI Model Review - General" ,
                             ncfilename="sst.mnmean.nc",
                             latrange=c(44,50),
                             lonrange=c(-125,-120)
                             )

#================
#Plot ERSST data
#================
# ggplot(sstdat,aes(x=factor(month),y=meanSST,group=year))+
#   geom_hline(yintercept=0,linetype="dashed")+
#   scale_color_brewer(palette = "Spectral")+
#   geom_line()+
#   facet_wrap(~factor(year))
# 
ggplot(sstdat,aes(x=factor(month),y=resid,group=year))+
  geom_hline(yintercept=0,linetype="dashed")+
  scale_color_brewer(palette = "Spectral")+
  geom_line()+
  facet_wrap(~factor(year))
# 
# ggplot(sstdat,aes(x=factor(month),y=sstdiff,group=year))+
#   geom_hline(yintercept=0,linetype="dashed")+
#   scale_color_brewer(palette = "Spectral")+
#   geom_line()+
#   facet_wrap(~factor(year))

ssta<-sstdat%>%
  dplyr::select(year,month,resid)%>%
  mutate(month=as.numeric(month))%>%
  mutate(year=ifelse(month>9,year+1,year))%>%
  group_by(year)%>%
  summarise(WSST_A = mean(resid[month>9|month<2]),
            SSST_A = mean(resid[month<=9|month>=4]),
            )
#================================================================
dat<-OPIHData%>%
  left_join(PDO)%>%
  left_join(NPGO)%>%
  left_join(indicators)%>%
  left_join(ssta)%>%
  mutate(species = "Coho",
         period = 1,
         lag1_log_JackOPI = log(lag1_JackOPI)
         )%>%
  ungroup()%>%
  dplyr::select(year,species,period,abundance,all_of(unique(unlist(covariates))))%>%
  filter(
    across(
      .cols = all_of(unique(unlist(covariates))),
      .fns = ~ !is.na(.x)
    )
  )

print(tail(dat))
```


## GET THIS LIST OF COVARIATES USED FOR OREGON COAST NATURAL FORECAST:
Multivariate ENSO Index (Oct-Dec; t-1)
Spring Transition (Julian date; t-1)
Upwelling (July-Sept; t-1)
Upwelling (Sep-Nov; t-1)
Sea Surface Temperature (Jan; t)
Sea Surface Height (April-June; t-1)
PDO (mean May-July; averaged over the 4-years prior to the return year)




## Results
This section present a a results table showing the performance of the prediction model in previous years as well as a forecast in the current year. The results in the table are graphed below.
```{r Analysis_v2, message=FALSE, warning=FALSE, results="show"}
if(find_best ==T){
  best_covariates<-all_subsets(series=dat,covariates=covariates,min=min_vars,max=max_vars,type=forecast_type)
  saveRDS(best_covariates,"best_covariates_OPI_preseason.rds")
}


# results<-inseason_forecast(series=summarized_data$series,
#                   leave_yrs=leave_yrs,
#                   covariates= c("lag2_NPGO","lag1_log_SAR2","lag2_log_smolts","var_flow","zl_flow"), #use to automate variable selection: best_covariates[[1]][[best_covariates[[2]]$model_num[1]]],
#                   first_forecast_period = first_forecast_period,
#                   plot_results = plot_results,
#                   write_model_summaries = write_model_summaries,
#                   forecast_period_start_m =  forecast_period_start_m, #inclusive 
#                   forecast_period_start_d =  forecast_period_start_d, #inclusive
#                   obs_period_2 = summarized_data$obs_period_2,
#                   p1_covariates_only = p1_covariates_only
#                   )

best_covariates<-readRDS("best_covariates_OPI_preseason.rds")

best_covariates[[2]]%>%
  slice(1:num_models)%>%
  kbl(caption = "Table 1. Covariate Model Selection Results.",digits =3)%>%
  kable_classic(full_width = F, html_font = "Cambria")

results<-preseason_forecast(series=dat,
                  leave_yrs=leave_yrs,
                  covariates= best_covariates[[1]][best_covariates[[2]]$model_num[1:num_models]],
                  first_forecast_period = first_forecast_period,
                  plot_results = plot_results,
                  write_model_summaries = write_model_summaries,
                  forecast_period_start_m =  forecast_period_start_m, #inclusive 
                  forecast_period_start_d =  forecast_period_start_d, #inclusive
                  stack_metric = stack_metric
                  )

model_list<-lapply(best_covariates[[1]][best_covariates[[2]]$model_num[1:num_models]],function(x) paste(x,collapse = " + "))%>%
  unlist()%>%
  as_tibble()%>%
  add_rownames()%>%
  dplyr::rename(model=rowname,model_name=value)

results%>%
  filter(year==max(year))%>%
  left_join(model_list)%>%
  dplyr::select(year,model_name,predicted_abundance,`Lo 50`,`Hi 50`,`Lo 95`,`Hi 95`,Stacking_weight)%>%
  kbl(caption = paste0("Table 2.Individual ensemble member predictions from the best ",num_models," models. These models were used to develop an ensemble using stacking weights which were optimized based on one-year-ahead performance over ",leave_yrs-1," years using ",stack_metric,". Optimized stacking weights are shown."),digits =2)%>%
  kable_classic(full_width = F, html_font = "Cambria")


if(length(unique(results$model))>1){

  results_best<-results%>%
  ungroup()%>%
  filter(model =="ensemble")%>%
  dplyr::select(-period)
}



results_best%>%
  dplyr::select(!c("train_test"))%>%
  kbl(caption = paste0("Table 3. One-year-ahead forecasts of OPI", species,". Additional covariates are included in the table below."),digits =2)%>%
  kable_classic(full_width = F, html_font = "Cambria")

print(paste0("Mean Absolute Percent Error (MAPE) = ",mean(abs((results_best$error/results$abundance)*100),na.rm = T)))
print(paste0("Median Symmetric Accuracy; MSA) = ",100*(exp(median(abs(log(results_best$predicted_abundance/results$abundance)),na.rm = T))-1)))

p<-ggplot(results_best,aes(x=year,y=predicted_abundance))+
  geom_ribbon(aes(ymin=`Lo 95`,ymax=`Hi 95`),color=NA,alpha=0.5,fill = "cadetblue")+
  geom_ribbon(aes(ymin=`Lo 50`,ymax=`Hi 50`),color=NA,alpha=0.5,fill = "cadetblue")+
  geom_line()+
  geom_point(aes(x=year,y=abundance))+
  ylim(0,NA)+
  scale_x_continuous(breaks=unique(results$year))

print(p)
```
