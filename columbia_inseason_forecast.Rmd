---
title: Columbia Summer Steelhead Inseason Forecast for Counts 7/1-7/31 @ Bonneville Dam
author: Thomas Buehrens (tbuehrens@dfw.wa.gov) 
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

***

Last Updated `r format(Sys.time(), '%m/%d/%Y')`.

***


# Overview
This script fits two regression models to in-season hatchery return data to predict total return

## Setup
All analyses require R software [**(link)**](https://cran.r-project.org/) (v3.4.3) for data retrieval, data processing, and summarizing model results. Here we configure R to perform our analysis and generate our outputs
```{r set_options, echo = TRUE, message = FALSE}
options(width = 100)
knitr::opts_chunk$set(message = FALSE)
set.seed(123)
```

We also need a couple of helper functions which we will define
```{r load_funcs, message = FALSE, warning = FALSE,results = "hide"}
#function to install or load packages
install_or_load_pack <- function(pack){
  create.pkg <- pack[!(pack %in% installed.packages()[, "Package"])]
  if (length(create.pkg))
    install.packages(create.pkg, dependencies = TRUE)
  sapply(pack, require, character.only = TRUE)
}


#function to evaluate performance of SARIMA model (produces season total forecasts only)
test_model2<-function(series,minyr,leaveout,leave_yrs,last_train_yr,covariates,lastyday){
  Y<-length(unique(series$year)) 
  S<-length(unique(series$yday))
  yday_7_1 = series%>%filter(year==min(year) & month(date)==7 & mday(date)==1)%>%dplyr::select(yday)%>%unlist()
  write.table(NULL,"summary.txt")
  for(i in 1:leave_yrs){
    tdat<-series%>%
      filter(year <= last_train_yr,
             yday <= lastyday | yday >= yday_7_1
             )
    last_yr = max(tdat$year) - (leave_yrs-i+1)
    tdat<-tdat%>%
      mutate(train_test=ifelse(year > last_yr & yday > (S-leaveout), 1, 0),
             period=ifelse(yday > (S-leaveout), 2,1)
      )%>%
      group_by_at(c("year","period","train_test",all_of(covariates)))%>%
      summarize(abundance=sum(abundance),.groups="keep")%>%
      filter(year <= (last_yr+1))
    
    exists<-tdat%>%filter(year==(last_yr+1) & period ==2)%>%ungroup%>%dplyr::select(abundance)%>%nrow()
    if(exists==0){
      adddat<-tdat%>%tail(1)
      adddat$period<-2
      adddat$abundance<-NA
      adddat$train_test<-1
      tdat<-tdat%>%
        bind_rows(adddat)
    }
    
    xreg<-tdat%>%
      filter(train_test==0)%>%
      ungroup%>%
      dplyr::select(covariates)%>%
      as.matrix()
    
    m1<-tdat%>%
      filter(train_test==0)%>%
      ungroup()%>%
      dplyr::select(abundance)%>%
      unlist()%>%
      ts(frequency = 2)%>%
      auto.arima(lambda=0,seasonal = T, xreg = xreg)
    
    sink("summary.txt",append=T)
      print(summary(m1))
    sink()
    
    pred<-c(m1$fitted,forecast::forecast(m1,lambda=0,h=1,
                                         xreg = tdat%>%
                                           filter(train_test==1)%>%
                                           ungroup%>%
                                           dplyr::select(covariates)%>%
                                           as.matrix()
                                         )$mean)
    CI<-forecast::forecast(m1,lambda=0,h=1, level = c(50, 95),
                           xreg = tdat%>%
                                           filter(train_test==1)%>%
                                           ungroup%>%
                                           dplyr::select(covariates)%>%
                                           as.matrix()
                           )%>%
      as_tibble()%>%
      dplyr::select(!`Point Forecast`)%>%
      mutate(year = last_yr+1, period = 2)
  
    
    tdat<-tdat%>%
      bind_cols(pred=pred)%>%
      left_join(CI, by = c("year","period"))
    
    
    p<-ggplot(data=tdat,aes(x=period,y=abundance, group=year,color=factor(train_test)))+
      facet_wrap(~year,scales = "free_x")+
      geom_errorbar(aes(ymin=`Lo 95`, ymax=`Hi 95`), width=.2, color="blue",position=position_dodge(.9))+
      geom_rect(aes(xmin=period-0.25,xmax=period+0.25, ymin=`Lo 50`, ymax=`Hi 50`),fill="white", colour="blue", size=0.5)+ 
      geom_point(mapping = aes(x=period,y=pred),color="blue",shape=3)+
      geom_point(size=2)+
      scale_x_continuous(breaks = c(1,2))+
      theme_bw()+
      ylim(0,NA)

    print(p)
    
    tdat<-tdat%>%
      dplyr::rename(predicted_abundance = pred)%>%
      filter(train_test==1)%>%
      mutate(error = predicted_abundance-abundance)

    
    if(i==1){results = tdat
    }else{results = results %>% bind_rows(tdat)}
  }
  return(results)
}

```

Here we will load & install packages we need to use (needs internet connection if packages not already installed)
```{r load_packages, message = FALSE, warning = FALSE,results = "hide"}
packages_list<-c("tidyverse"
                 ,"forecast"
                 ,"mgcv"
                 ,"ggplot2"
                 ,"MASS"
                 ,"RColorBrewer"
                 ,"kableExtra"
                 ,"lubridate"
                 ,"modelr"
                 ,"kableExtra"
                 ,"reshape2"
                 ,"ggfortify"
                 ,"clock"
                 ,"smooth"
                 )
install_or_load_pack(pack = packages_list)
```

## User Inputs To Get Data

```{r user_inputs_data, message = FALSE, warning = FALSE,results = "show"}

minyr<-2003 #first year in  dataset
min_BON_M <- 3
min_BON_D <- 15
```

## Get Data
```{r Analysis_get_data, message=FALSE, warning=FALSE, results="show"}

for(yr in minyr:year(Sys.Date())){
  if(yr==minyr){
    series<-tibble(NULL)
  }
  series<-series%>%
  bind_rows(read_csv(paste0("https://www.cbr.washington.edu/dart/cs/php/rpt/adult_daily.php?sc=1&outputFormat=csv&year=",yr,"&proj=BON&span=no&startdate=",min_BON_M,"%2F",min_BON_D,"&enddate=7%2F31&run=&syear=",yr,"&eyear=",yr))%>%
  dplyr::select(Date,WStlhd)%>%
  filter(!is.na(Date)))
}
series<-series%>%
  dplyr::rename(abundance=WStlhd, date = Date)%>%
  mutate(yday = yday(date)-min(yday(date))+1, 
         year = year(date),
         abundance = ifelse(is.na(abundance)|abundance < 0,0,abundance)
         )

print(series)

p<-ggplot(data=series%>%filter(year<max(year) & yday >= 109)%>%group_by(year)%>%mutate(abundance=cumsum(abundance)),aes(x=date,y=abundance,group=year))+
  facet_wrap(~year,scales = "free")+
  geom_point()+
  geom_line()
print(p)

ggplot(series%>%filter(year<max(year) & yday >= 109)%>%group_by(year)%>%summarise(abundance=sum(abundance),.groups = "keep"), aes(x=year,y=abundance))+
  geom_line()+
  geom_point()+
  ylim(0,NA)


#===============================
# get bonneville winter run data
#===============================
BONlatewinters<-read_csv("https://www.cbr.washington.edu/dart/cs/php/rpt/adult_annual.php?sc=1&outputFormat=csv&proj=BON&startdate=3%2F15&enddate=5%2F15&run=")%>%
  as_tibble()%>%
  dplyr::select(Year,BONlatewinters =`Wild Steelhead`)%>%
  filter(!BONlatewinters == 0)%>%
  mutate(log_BON_WWS = log(BONlatewinters),
         diff_log_BON_WWS = c(NA,diff(log_BON_WWS))
         )%>%
  dplyr::select(year=Year,log_BON_WWS,diff_log_BON_WWS)
#=========================================================
#get NPGO data
#=========================================================
NPGO<-read_table("http://www.o3d.org/npgo/npgo.php",skip=29,col_names=F,comment="#")%>%
  filter(!is.na(X2))%>%
  dplyr::rename(Year=X1,Month=X2,NPGO=X3)%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Year)%>%
  add_tally()%>%
  #filter(!Month>6)%>% #use only spring (Jan-June) NPGO
  filter(!n < 12)%>% #use only complete years
  group_by(Year)%>%
  dplyr::summarise(NPGO=mean(NPGO))%>%
  mutate(Year=Year+1, lag1_NPGO = NPGO,lag2_NPGO = lag(NPGO))%>%
  dplyr::select(year=Year,lag1_NPGO,lag2_NPGO)
# #=========================================================
# #get PIT tag survival/age data
# #=========================================================
PIT<-read_csv("https://raw.githubusercontent.com/tbuehrens/Salmon_Forecast_Example/main/data/Columbia_Steelhead_SAR_DART_11_1_2021.csv")%>%
  dplyr::rename(OutmigrationYear=year)%>%
  mutate(Year=OutmigrationYear+2)%>%
  filter(Pop=="SNA")

PIT<-PIT%>%bind_cols(data.frame(SAR1=gam(cbind(ocean1Count,juvCount-ocean1Count)~s(OutmigrationYear,k=(dim(PIT)[1])),family=binomial,data=PIT)$fitted))%>%
  bind_cols(data.frame(SAR2=c(gam(cbind(ocean2Count,juvCount-ocean2Count)~s(OutmigrationYear,k=(dim(PIT)[1]-1)),family=binomial,data=PIT)$fitted,NA)))%>%
  mutate(lag1_log_SAR1 = log(SAR1),lag1_log_SAR2=lag(log(SAR2),1))%>%
  dplyr::select(year=Year,lag1_log_SAR1,lag1_log_SAR2)

series<-series%>%
  left_join(BONlatewinters)%>%
  left_join(NPGO)%>%
  left_join(PIT)

```

## User Inputs To Run SARIMA training, testing & forecasting
```{r user_inputs_model, message = FALSE, warning = FALSE,results = "show"}
#==================
#forecasting params
#==================
leaveout<-NA # days of season to leave out of forecast
leave_yrs<- 16
last_train_yr<-year(Sys.Date()) # year(Sys.Date()) -1  #if running with data not yet seen this year
leaveout <-31
lastyday <- last(series$yday)
#lastyday<-yday(as.Date("2022-07-01"))-yday(min(series$date))
covariates<-c("lag1_log_SAR1","lag2_NPGO")#, "lag1_log_SAR2","lag1_NPGO","log_BON_WWS","diff_log_BON_WWS")
```



## SARIMA results

```{r Analysis_v2, message=FALSE, warning=FALSE, results="show"}
results2<-test_model2(series=series,
                      minyr=minyr,
                      leaveout=leaveout,
                      leave_yrs=leave_yrs,
                      last_train_yr = last_train_yr,
                      lastyday = lastyday,
                      covariates=covariates
                      ) 
results2<-results2%>%
  mutate(pct_error=error/abundance*100)

results2%>%
  ungroup()%>%
  dplyr::select(!c("period","train_test"))%>%
  kbl(caption = paste0("Table 2. Forecasts of BON wild steelhead counts 7/1-7/31 using only past years' data and in-season counts up until ", month(last(as.Date(series$date))),"/",mday(as.Date(last(series$date))), " in each year. Results are based on a SARIMA model using a two count sums at BON: the count from 3/15 to the latest day of available data, and counts from 7/1 to 7/31. Additional covariates are included in the table below."),digits =2)%>%
  kable_classic(full_width = F, html_font = "Cambria")

print(paste0("Mean Absolute Percent Error (MAPE) = ",mean(abs(results2$pct_error),na.rm = T)))
print(paste0("Geomean Absolute Percent Error (also known as Median Symmetric Accuracy; MSA) = ",exp(mean(abs(log(results2$pct_error)),na.rm = T))))
```
